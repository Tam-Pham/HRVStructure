---
output: html_document
editor_options: 
  chunk_output_type: console
---



### Convenience Functions

```{r eval=TRUE}
library(ggraph)
```


#### Cleaning

```{r eval=TRUE, class.source = "fold-hide"}
clean_names <- function(n) {
  n[n == "DFA_alpha1_ExpMean"] <- "DFA α1 ExpMean"

  n[n == "DFA_alpha2_ExpMean"] <- "DFA α2 ExpMean"

  n[n == "DFA_alpha1_ExpRange"] <- "DFA α1 ExpRange"

  n[n == "DFA_alpha2_ExpRange"] <- "DFA α2 ExpRange"

  n[n == "DFA_alpha1_DimMean"] <- "DFA α1 DimMean"

  n[n == "DFA_alpha2_DimMean"] <- "DFA α2 DimMean"

  n[n == "DFA_alpha1_DimRange"] <- "DFA α1 DimRange"
  
  n[n == "DFA_alpha2_DimRange"] <- "DFA α2 DimRange"
  
  n[n == "DFA_alpha1"] <- "DFA α1"
  
  n[n == "DFA_alpha2"] <- "DFA α2"

  n[n == "CSI_Modified"] <- "CSI (modified)"

  n
}


assign_clusters <- function(table_clusters, data, clusters, col = "Hclust") {
  table_clusters[[col]] <- NA
  table_clusters[[col]][table_clusters$Index %in% row.names(data)] <- clusters
  table_clusters[[col]][table_clusters[[col]] == "0"] <- seq(length(unique(clusters)),sum(clusters == "0") + length(unique(clusters)) - 1)
  table_clusters
}


```

#### Dendrogram

```{r eval=TRUE, class.source = "fold-hide"}
plot_dendrogram <- function(model, clusters = NULL, points = TRUE, dis = NULL, ylim = -0.3, nudge_y = -0.02, angle = 90, h = NULL, edges = "elbow") {
  if(is.null(clusters)) {
    data <- tidygraph::as_tbl_graph(model)
  } else {
    data <- tidygraph::as_tbl_graph(model) %>% 
      tidygraph::activate(nodes) %>% 
      mutate(cluster = as.character(clusters[label]))
  }
  if(!is.null(dis)) {
    data <- data %>% 
      mutate(dis = as.character(dis[label]))
  }
  
  # Tree
  p <- ggraph(data, layout = 'dendrogram', height = height)
    
  if(edges == "elbow") {
    p <- p + geom_edge_elbow()
  } else {
    p <- p + geom_edge_diagonal()
  }
    
    
  # Hline
  if(!is.null(h)) p <- p + geom_hline(yintercept = h, linetype = "dotted") 
  

  # Points
  if(points) {
    if(is.null(clusters)) {
      p <- p + geom_node_point(aes(filter=leaf))
    } else {
      p <- p + geom_node_point(aes(color = cluster, filter = leaf, size = dis))
    }
  }
  
  if(is.null(clusters)) {
    p <- p + geom_node_text(aes(label=label), angle = angle, hjust=1, nudge_y = nudge_y)
  } else {
    p <- p + geom_node_text(aes(label=label, color = cluster), angle = angle, hjust=1, nudge_y = nudge_y) +
      scale_colour_material_d(palette = "rainbow", guide = "none", na.value = "grey")
  }
 p + 
   ylim(ylim, NA) +
   theme_void()
}
```



#### Correlations

```{r eval=TRUE, class.source = "fold-hide"}
plot_correlation <- function(data, x = "Recording_Length", y = "RMSSD", xlab = x, ylab = y, color = "red", label = NULL) {
  data %>%
    ggplot(aes_string(x = x, y = y)) +
    geom_point2(size = 4, alpha = 0.66) +
    geom_smooth(method = "lm", formula = y ~ poly(x, 2), color = color, fill = color, alpha = 0.1, size = 1.5, se = FALSE) +
    annotate("label",
      x = min(data[[x]], na.rm = TRUE),
      y = max(data[[y]], na.rm = TRUE),
      label = label,
      hjust = 0
    ) +
    xlab(xlab) +
    ylab(ylab) +
    theme_modern() +
    ggside::geom_xsidedensity() +
    ggside::geom_ysidedensity() +
    ggside::scale_xsidey_continuous(breaks = NULL, labels = "", expand = expansion(c(0, 0))) +
    ggside::scale_ysidex_continuous(breaks = NULL, labels = "", expand = expansion(c(0, 0)))
}


plot_correlations <- function(data, r, color = NA) {
  r$label <- paste0(
      "r = ",
      insight::format_value(r$r),
      insight::format_p(r$p, stars_only = TRUE),
      ", ",
      insight::format_ci(r$CI_low, r$CI_high, r$CI, zap_small = TRUE)
    )
  r$xlab <- clean_names(r$Parameter1)
  r$ylab <- clean_names(r$Parameter2)
  
  ps <- list()
  for(i in 1:nrow(r)) {
    ps[[i]] <- plot_correlation(data, 
                                x = r$Parameter1[i], 
                                y = r$Parameter2[i], 
                                xlab = r$xlab[i], 
                                ylab = r$ylab[i], 
                                color = "red", 
                                label = r$label[i]) +
      theme(axis.title.x = element_blank())
  }
  
  ggpubr::ggarrange(plotlist = ps)
}
```
