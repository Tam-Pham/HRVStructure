---
output: html_document
editor_options: 
  chunk_output_type: console
---


### Clustering


```{r, message=FALSE, warning=FALSE}
# Preprocessing
z <- standardize(data[hrv_cols])
z <- z[ , colSums(is.na(z)) > 0.05 * nrow(z)]
z[is.na(z)] <- 0  # mean imputation
z <- datawizard::data_transpose(z)
```


#### K-Means

##### How Many Clusters

```{r, message=FALSE, warning=FALSE}
n <- parameters::n_clusters(z, 
                            standardize = FALSE, 
                            package= c("NbClust", "easystats", "mclust"), 
                            nbclust_method = "ward.D2",
                            n_max = 10,
                            fast = FALSE)

n

plot(n) 
```


##### Clustering

```{r, message=FALSE, warning=FALSE}
rez <- parameters::cluster_analysis(z, n = 2, method = "hkmeans")

as.data.frame(rez)[1:3]

cluster_performance(rez)

plot(rez)


table_clusters$Kmeans <- NA
table_clusters$Kmeans[table_clusters$Index %in% row.names(z)] <- as.character(predict(rez))
```



#### Hierarchial Clustering

##### Clustering

```{r, message=FALSE, warning=FALSE}
rez <- parameters::cluster_analysis(z, n = NULL, standardize = FALSE, method = "hclust", distance_method = "correlation", hclust_method = "average", ci = 0.90)

as.data.frame(rez)[1:3]

cluster_performance(rez)

plot(rez)


table_clusters$Hclust <- NA
table_clusters$Hclust[table_clusters$Index %in% row.names(z)] <- as.character(predict(rez))
table_clusters$Hclust[table_clusters$Hclust == "0"] <- NA
```


##### Dendrogram

```{r, message=FALSE, warning=FALSE}
clusters <- table_clusters$Hclust
names(clusters) <- table_clusters$Index

plot_dendrogram(model = attributes(rez)$model$hclust, clusters = clusters)
```

#### DBSCAN

##### Parameters Selection

```{r, message=FALSE, warning=FALSE}
n <- n_clusters_dbscan(z, standardize = FALSE, eps_range = c(0.1, 30), min_size = 2, method = "kNN")
plot(n)
```

##### Clustering

```{r, message=FALSE, warning=FALSE}
rez <- parameters::cluster_analysis(z, n = NULL, standardize = FALSE, method = "dbscan", dbscan_eps = 16, min_size = 2)

as.data.frame(rez)[1:3]

cluster_performance(rez)

plot(rez)


table_clusters$DBSCAN <- NA
table_clusters$DBSCAN[table_clusters$Index %in% row.names(z)] <- as.character(predict(rez))
table_clusters$DBSCAN[table_clusters$DBSCAN == "0"] <- NA
row.names(table_clusters) <- table_clusters$Index
```
