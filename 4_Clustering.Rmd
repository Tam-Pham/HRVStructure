---
output: html_document
editor_options: 
  chunk_output_type: console
---


### Clustering


```{r, message=FALSE, warning=FALSE, cache = TRUE}
# Preprocessing
z <- standardize(data[hrv_cols])
z <- z[ , colSums(is.na(z)) < 0.1 * nrow(z)]  # keep only cols with few nans
z[is.na(z)] <- 0  # mean imputation
z <- datawizard::data_transpose(z)
```


#### K-Means

##### How Many Clusters

```{r, message=FALSE, warning=FALSE}
set.seed(3)

n <- parameters::n_clusters(z, 
                            standardize = FALSE, 
                            package= c("NbClust", "easystats", "mclust"), 
                            nbclust_method = "average",
                            n_max = 15,
                            fast = FALSE)

n

plot(n)

plot(n_clusters_gap(z, standardize = FALSE))
```


##### 7-K Solution

```{r, message=FALSE, warning=FALSE}
rez <- parameters::cluster_analysis(z, n = 7, method = "hkmeans")

as.data.frame(rez)[1:3]

cluster_performance(rez)

plot(rez)


table_clusters$Kmeans_8 <- NA
table_clusters$Kmeans_8[table_clusters$Index %in% row.names(z)] <- as.character(predict(rez))
```

##### 5-K Solution

```{r, message=FALSE, warning=FALSE}
rez <- parameters::cluster_analysis(z, n = 5, method = "hkmeans")

as.data.frame(rez)[1:3]

cluster_performance(rez)

plot(rez)


table_clusters$Kmeans_5 <- NA
table_clusters$Kmeans_5[table_clusters$Index %in% row.names(z)] <- as.character(predict(rez))
```

#### Hierarchial Clustering

##### Clustering

```{r, message=FALSE, warning=FALSE}
rez <- parameters::cluster_analysis(z, n = NULL, standardize = FALSE, method = "hclust", distance_method = "correlation", hclust_method = "average", ci = 0.90)

as.data.frame(rez)[1:3]

cluster_performance(rez)

plot(rez)


table_clusters$Hclust <- NA
table_clusters$Hclust[table_clusters$Index %in% row.names(z)] <- as.character(predict(rez))
table_clusters$Hclust[table_clusters$Hclust == "0"] <- NA
```


##### Dendrogram

```{r, message=FALSE, warning=FALSE}
clusters <- table_clusters$Hclust
names(clusters) <- table_clusters$Index

plot_dendrogram(model = attributes(rez)$model$hclust, clusters = clusters)
```

#### DBSCAN

##### Parameters Selection

```{r, message=FALSE, warning=FALSE}
n <- n_clusters_dbscan(z, standardize = FALSE, eps_range = c(0.1, 30), min_size = 2, method = "kNN")
plot(n)
```

##### DBSCAN

```{r, message=FALSE, warning=FALSE}
rez <- parameters::cluster_analysis(z, n = NULL, standardize = FALSE, method = "dbscan", dbscan_eps = 16, min_size = 2, borderPoints = TRUE)

as.data.frame(rez)[1:3]

cluster_performance(rez)

plot(rez)

table_clusters$DBSCAN <- NA
table_clusters$DBSCAN[table_clusters$Index %in% row.names(z)] <- as.character(predict(rez))
table_clusters$DBSCAN[table_clusters$DBSCAN == "0"] <- NA
```

##### HDBSCAN

```{r, message=FALSE, warning=FALSE}
rez <- parameters::cluster_analysis(z, n = NULL, standardize = FALSE, method = "hdbscan", min_size = 2)

as.data.frame(rez)[1:3]

cluster_performance(rez)

plot(rez)

table_clusters$HDBSCAN <- NA
table_clusters$HDBSCAN[table_clusters$Index %in% row.names(z)] <- as.character(predict(rez))
table_clusters$HDBSCAN[table_clusters$HDBSCAN == "0"] <- NA
```

#### Mixture Modelling


```{r, message=FALSE, warning=FALSE}
suppressMessages(library(mclust))

rez <- parameters::cluster_analysis(z, method = "mixture")

as.data.frame(rez)[1:3]

cluster_performance(rez)

plot(rez)


table_clusters$Mixture <- NA
table_clusters$Mixture[table_clusters$Index %in% row.names(z)] <- as.character(predict(rez))
table_clusters$Mixture[table_clusters$Mixture == "0"] <- NA
```
